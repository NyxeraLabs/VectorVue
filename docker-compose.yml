# Copyright (c) 2026 José María Micoli
# Licensed under {'license_type': 'BSL1.1', 'change_date': '2033-02-17'}
#
# You may:
# ✔ Study
# ✔ Modify
# ✔ Use for internal security testing
#
# You may NOT:
# ✘ Offer as a commercial service
# ✘ Sell derived competing products

services:
  vectorvue_app:
    build:
      context: .
      dockerfile: Dockerfile
    image: vectorvue:phase6
    container_name: "${COMPOSE_PROJECT_NAME:-vectorvue}_app"
    restart: unless-stopped
    read_only: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      POSTGRES_USER: vectorvue
      POSTGRES_PASSWORD: strongpassword
      POSTGRES_DB: vectorvue_db
      VV_DB_BACKEND: postgres
      VV_DB_HOST: postgres
      VV_DB_PORT: "5432"
      VV_DB_NAME: vectorvue_db
      VV_DB_USER: vectorvue
      VV_DB_PASSWORD: strongpassword
      VV_DB_URL: postgresql://vectorvue:strongpassword@postgres:5432/vectorvue_db
      VV_REDIS_HOST: redis
      VV_REDIS_PORT: "6379"
      VV_REDIS_PASSWORD: strongpassword
      VV_HEALTH_PORT: "8080"
      VV_RUN_MODE: api
      VV_REPORTS_DIR: /var/lib/vectorvue/reports
      VV_LOG_DIR: /var/lib/vectorvue/logs
      VV_CLIENT_JWT_SECRET: change-me-phase7b-client-jwt-secret
      TERM: xterm-256color
      COLORTERM: truecolor
      FORCE_COLOR: "1"
    volumes:
      - vectorvue_reports:/var/lib/vectorvue/reports
      - vectorvue_logs:/var/lib/vectorvue/logs
      - vectorvue_runtime:/var/lib/vectorvue/run
      - vectorvue_tmp:/var/lib/vectorvue/tmp
      - vectorvue_config:/opt/vectorvue/config
    tmpfs:
      - /tmp:size=64m,noexec,nosuid,nodev
      - /run:size=16m,nosuid,nodev
    tty: true
    stdin_open: true
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://127.0.0.1:8080/healthz', timeout=3).read()\" || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 20s
    command: ["python", "-m", "uvicorn", "vv_client_api:app", "--host", "0.0.0.0", "--port", "8080", "--proxy-headers"]

  vectorvue_portal:
    build:
      context: ./portal
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_URL: http://vectorvue_app:8080
    image: vectorvue-portal:phase7b
    container_name: "${COMPOSE_PROJECT_NAME:-vectorvue}_portal"
    restart: unless-stopped
    read_only: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    depends_on:
      vectorvue_app:
        condition: service_healthy
    environment:
      NEXT_PUBLIC_API_URL: http://vectorvue_app:8080
      NEXT_PUBLIC_BRAND_NAME: VectorVue Client Portal
      NEXT_PUBLIC_BRAND_ACCENT: "#22d3ee"
      VV_TENANT_HOST_MAP: "${VV_TENANT_HOST_MAP:-acme.vectorvue.local=10000000-0000-0000-0000-000000000001|ACME Industries,globex.vectorvue.local=20000000-0000-0000-0000-000000000002|Globex Corporation,vectorvue.local=10000000-0000-0000-0000-000000000001|ACME Industries}"
      PORT: "3000"
      HOSTNAME: "0.0.0.0"
      NODE_ENV: production
    tmpfs:
      - /tmp:size=64m,noexec,nosuid,nodev
      - /app/.next/cache:size=128m,nosuid,nodev
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:3000/login >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 25s

  vectorvue_runtime:
    image: vectorvue:phase6
    container_name: "${COMPOSE_PROJECT_NAME:-vectorvue}_runtime"
    restart: unless-stopped
    read_only: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      POSTGRES_USER: vectorvue
      POSTGRES_PASSWORD: strongpassword
      POSTGRES_DB: vectorvue_db
      VV_DB_BACKEND: postgres
      VV_DB_HOST: postgres
      VV_DB_PORT: "5432"
      VV_DB_NAME: vectorvue_db
      VV_DB_USER: vectorvue
      VV_DB_PASSWORD: strongpassword
      VV_DB_URL: postgresql://vectorvue:strongpassword@postgres:5432/vectorvue_db
      VV_REDIS_HOST: redis
      VV_REDIS_PORT: "6379"
      VV_REDIS_PASSWORD: strongpassword
      VV_LOG_DIR: /var/lib/vectorvue/logs
      VV_RUN_MODE: service
    volumes:
      - vectorvue_logs:/var/lib/vectorvue/logs
      - vectorvue_runtime:/var/lib/vectorvue/run
      - vectorvue_tmp:/var/lib/vectorvue/tmp
    tmpfs:
      - /tmp:size=64m,noexec,nosuid,nodev
      - /run:size=16m,nosuid,nodev
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import vv_core_postgres as m; import sys; s=m._health_snapshot().get('status'); sys.exit(0 if s in ('healthy','degraded') else 1)\""]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 20s
    command: ["python", "-m", "vv_core_postgres", "--mode", "service", "--disable-health-server"]

  vectorvue_ml_worker:
    image: vectorvue:phase6
    container_name: "${COMPOSE_PROJECT_NAME:-vectorvue}_ml_worker"
    restart: unless-stopped
    read_only: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      VV_DB_BACKEND: postgres
      VV_DB_URL: postgresql://vectorvue:strongpassword@postgres:5432/vectorvue_db
      VV_REDIS_URL: redis://:strongpassword@redis:6379/0
      VV_ANALYTICS_STORAGE_DIR: /storage
      VV_ML_WORKER_LOG_LEVEL: INFO
    volumes:
      - vectorvue_logs:/var/lib/vectorvue/logs
      - vectorvue_analytics:/storage
      - vectorvue_tmp:/var/lib/vectorvue/tmp
    tmpfs:
      - /tmp:size=64m,noexec,nosuid,nodev
      - /run:size=16m,nosuid,nodev
    command: ["python", "-m", "analytics.worker"]

  vectorvue_compliance_observation_worker:
    image: vectorvue:phase6
    container_name: "${COMPOSE_PROJECT_NAME:-vectorvue}_compliance_observation_worker"
    restart: unless-stopped
    read_only: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      VV_DB_BACKEND: postgres
      VV_DB_URL: postgresql://vectorvue:strongpassword@postgres:5432/vectorvue_db
      VV_REDIS_URL: redis://:strongpassword@redis:6379/0
      VV_COMPLIANCE_WORKER_LOG_LEVEL: INFO
    volumes:
      - vectorvue_logs:/var/lib/vectorvue/logs
      - vectorvue_tmp:/var/lib/vectorvue/tmp
    tmpfs:
      - /tmp:size=64m,noexec,nosuid,nodev
      - /run:size=16m,nosuid,nodev
    command: ["python", "-m", "workers.observation_worker"]

  vectorvue_compliance_daily_worker:
    image: vectorvue:phase6
    container_name: "${COMPOSE_PROJECT_NAME:-vectorvue}_compliance_daily_worker"
    restart: unless-stopped
    read_only: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      VV_DB_BACKEND: postgres
      VV_DB_URL: postgresql://vectorvue:strongpassword@postgres:5432/vectorvue_db
      VV_REDIS_URL: redis://:strongpassword@redis:6379/0
      VV_COMPLIANCE_WORKER_LOG_LEVEL: INFO
      VV_COMPLIANCE_SIGNING_KEY: change-me-phase9-compliance-signing-key
    volumes:
      - vectorvue_logs:/var/lib/vectorvue/logs
      - vectorvue_tmp:/var/lib/vectorvue/tmp
    tmpfs:
      - /tmp:size=64m,noexec,nosuid,nodev
      - /run:size=16m,nosuid,nodev
    command: ["python", "-m", "workers.daily_compliance_job"]

  postgres:
    image: postgres:16
    container_name: "${COMPOSE_PROJECT_NAME:-vectorvue}_postgres"
    restart: unless-stopped
    environment:
      POSTGRES_USER: vectorvue
      POSTGRES_PASSWORD: strongpassword
      POSTGRES_DB: vectorvue_db
    command: ["postgres", "-c", "config_file=/etc/postgresql/postgresql.conf", "-c", "hba_file=/etc/postgresql/pg_hba.conf"]
    ports:
      - "${POSTGRES_HOST_PORT:-5433}:5432"
    volumes:
      - vectorvue_pg_data:/var/lib/postgresql/data
      - ./deploy/postgres/postgresql.conf:/etc/postgresql/postgresql.conf:ro
      - ./deploy/postgres/pg_hba.conf:/etc/postgresql/pg_hba.conf:ro
      - ./deploy/postgres/init:/docker-entrypoint-initdb.d:ro
      - ./deploy/certs:/var/lib/postgresql/certs:ro
      - vectorvue_logs:/var/log/vectorvue
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U vectorvue -d vectorvue_db"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 10s

  redis:
    image: redis:7-alpine
    container_name: "${COMPOSE_PROJECT_NAME:-vectorvue}_redis"
    restart: unless-stopped
    command: ["redis-server", "--appendonly", "yes", "--save", "60", "1000", "--requirepass", "strongpassword"]
    volumes:
      - vectorvue_redis_data:/data
      - vectorvue_logs:/var/log/vectorvue
    healthcheck:
      test: ["CMD-SHELL", "redis-cli -a strongpassword ping | grep -q PONG"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 5s

  nginx:
    image: nginx:1.27-alpine
    container_name: "${COMPOSE_PROJECT_NAME:-vectorvue}_nginx"
    restart: unless-stopped
    depends_on:
      vectorvue_app:
        condition: service_healthy
      vectorvue_portal:
        condition: service_healthy
    ports:
      - "${HTTP_HOST_PORT:-80}:80"
      - "${HTTPS_HOST_PORT:-443}:443"
    read_only: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
      - CHOWN
      - SETUID
      - SETGID
    volumes:
      - ./deploy/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./deploy/nginx/conf.d:/etc/nginx/conf.d:ro
      - ./deploy/certs:/etc/nginx/certs:ro
      - vectorvue_logs:/var/log/vectorvue
    tmpfs:
      - /var/cache/nginx:size=64m,nosuid,nodev
      - /var/run:size=16m,nosuid,nodev
    healthcheck:
      test: ["CMD-SHELL", "wget --no-check-certificate -qO- https://127.0.0.1/healthz | grep -q healthy"]
      interval: 15s
      timeout: 5s
      retries: 8
      start_period: 15s

volumes:
  vectorvue_pg_data:
  vectorvue_redis_data:
  vectorvue_reports:
  vectorvue_logs:
  vectorvue_runtime:
  vectorvue_tmp:
  vectorvue_config:
  vectorvue_analytics:
