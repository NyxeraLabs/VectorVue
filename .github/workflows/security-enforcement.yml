name: Security Enforcement

on:
  push:
    branches:
      - 'feat/**'
      - dev
      - qa
      - QA
  pull_request:
    branches:
      - dev
      - qa
      - QA
      - main

permissions:
  contents: read

concurrency:
  group: security-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sast:
    name: SAST (Bandit)
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Bandit
        run: |
          python -m pip install --upgrade pip
          pip install bandit

      - name: Run SAST
        run: |
          bandit -q -r services security app api -x tests

  dependency-scan:
    name: Dependency Scan (pip-audit)
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install scanner
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit

      - name: Scan dependencies
        run: pip-audit -r requirements.txt

  security-regression:
    name: Security Regression Gates
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Enforce policy gate (mTLS/signature/tenant guards)
        run: python scripts/security_ci_policy_gate.py

      - name: Run security regression unit tests
        run: |
          python -m unittest tests/unit/test_tenant_isolation.py -v
          python -m unittest tests/unit/test_phase1_sprint11_telemetry_gateway.py -v
          python -m unittest tests/unit/test_phase6_sprint61_tamper_log.py -v
          python -m unittest tests/unit/test_phase7_sprint71_federation.py -v
          python -m unittest tests/unit/test_phase8_sprint81_security_ci_gate.py -v
          python -m unittest tests/unit/test_phase9_sprint91_redteam_attacks.py -v
